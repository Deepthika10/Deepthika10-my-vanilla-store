<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="navbar-container"></div>
    <div class="container">
        <h1>Your Cart & Checkout</h1>
        <div id="cart-items-container"></div>
        <div class="form-container" style="margin-top: 2rem;">
            <h3>Delivery Details (Cash on Delivery)</h3>
            <form id="checkout-form">
                <label for="name">Full Name</label>
                <input type="text" id="name" required>
                <label for="address">Full Address</label>
                <input type="text" id="address" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Place Order</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabaseClient.js';
        import { setupNavbar } from './js/auth.js';
        import { getCart, clearCart } from './js/cart.js';

        setupNavbar();

        const cartItems = getCart();
        const container = document.getElementById('cart-items-container');
        let totalPrice = 0;

        if (cartItems.length === 0) {
            container.innerHTML = '<p>Your cart is empty.</p>';
            document.getElementById('checkout-form').style.display = 'none';
        } else {
            let itemsHtml = '<ul>';
            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                totalPrice += itemTotal;
                itemsHtml += `<li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                    <span>${item.name} (x${item.quantity})</span>
                    <span>$${itemTotal.toFixed(2)}</span>
                </li>`;
            });
            itemsHtml += `</ul><h2 style="text-align: right; margin-top: 1rem;">Total: $${totalPrice.toFixed(2)}</h2>`;
            container.innerHTML = itemsHtml;
        }

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                alert('You must be logged in to place an order.');
                window.location.href = '/login.html';
                return;
            }

            const customerDetails = {
                name: document.getElementById('name').value,
                address: document.getElementById('address').value,
            };

            const { error } = await supabase.from('orders').insert({
                user_id: user.id,
                total_price: totalPrice,
                customer_details: customerDetails,
                status: 'pending' // Default status
            });

            if (error) {
                alert('Error placing order: ' + error.message);
            } else {
                alert('Notification: Your order has been placed!');
                clearCart();
                window.location.href = '/my-orders.html';
            }
        });
    </script>
</body>
</html>
